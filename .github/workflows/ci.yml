name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  frontend-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm ci

      - name: Type check
        working-directory: frontend
        run: |
          npm run type-check

      - name: Run unit tests (Vitest)
        working-directory: frontend
        run: |
          npm run test:run

      - name: Run lint
        working-directory: frontend
        run: |
          npm run lint || true
name: CI - root / frontend / backend

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  root:
    name: Root (install & tests if present)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install root deps (if package.json present)
        shell: pwsh
        run: |
          if (Test-Path package.json) { npm ci } else { echo "No root package.json, skipping npm ci" }

      - name: Run root linter (if present)
        shell: pwsh
        run: |
          if (Test-Path package.json) { npm run lint --if-present } else { echo "No root package.json, skipping lint" }

      - name: Run root tests (if present)
        shell: pwsh
        run: |
          if (Test-Path package.json) { npm run test --if-present } else { echo "No root package.json, skipping tests" }

  frontend:
    name: Frontend (Vite)
    runs-on: ubuntu-latest
    needs: root
    steps:
      - uses: actions/checkout@v4

      - name: Check frontend directory
        id: check
        shell: pwsh
        run: |
          if (Test-Path frontend\package.json) { echo "exists=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 } else { echo "exists=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 }

      - name: Setup Node.js (frontend)
        if: steps.check.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install frontend deps
        if: steps.check.outputs.exists == 'true'
        shell: pwsh
        run: |
          cd frontend; npm ci

      - name: Run frontend build & tests
        if: steps.check.outputs.exists == 'true'
        shell: pwsh
        run: |
          cd frontend; npm run build --if-present; npm run test --if-present

      - name: Skip frontend
        if: steps.check.outputs.exists == 'false'
        run: echo "No frontend/package.json found — skipping frontend job"

  backend:
    name: Backend (Node / migrations)
    runs-on: ubuntu-latest
    needs: root
    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
      APP_URL: ${{ secrets.APP_URL }}
      SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
    steps:
      - uses: actions/checkout@v4

      - name: Check backend directory
        id: check-backend
        shell: pwsh
        run: |
          if (Test-Path backend\package.json) { echo "exists=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 } else { echo "exists=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 }

      - name: Setup Node.js (backend)
        if: steps.check-backend.outputs.exists == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend deps
        if: steps.check-backend.outputs.exists == 'true'
        shell: pwsh
        run: |
          cd backend; npm ci

      - name: Validate environment (secrets)
        if: github.event_name == 'push' && steps.check-backend.outputs.exists == 'true'
        shell: pwsh
        run: |
          cd backend; CHECK_SECRETS=1 npm run check:env

      - name: Run backend lint & tests
        if: steps.check-backend.outputs.exists == 'true'
        shell: pwsh
        run: |
          cd backend; npm run lint --if-present; npm run test --if-present

      - name: Skip backend
        if: steps.check-backend.outputs.exists == 'false'
        run: echo "No backend/package.json found — skipping backend job"

  integration:
    name: Integration tests (Postgres service)
    runs-on: ubuntu-latest
    needs: [root]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install deps
        run: npm ci
        shell: pwsh

      - name: Wait for Postgres
        run: |
          Write-Host "Waiting for Postgres to be ready...";
          $retries = 0; while ($retries -lt 10) { if (pg_isready -h localhost -p 5432 -U postgres) { break } ; Start-Sleep -Seconds 2; $retries++ }; 
        shell: pwsh

      - name: Apply migrations
        run: |
          Write-Host "Applying migrations...";
          Get-ChildItem migrations/*.sql | ForEach-Object { psql -h localhost -p 5432 -U postgres -d postgres -f $_.FullName }
        shell: pwsh

      - name: Run integration tests
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
        run: |
          npm run test:integration
        shell: pwsh

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    needs: [root, backend]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Wait for Postgres
        run: |
          Write-Host "Waiting for Postgres to be ready...";
          $retries = 0; while ($retries -lt 10) { if (pg_isready -h localhost -p 5432 -U postgres) { break } ; Start-Sleep -Seconds 2; $retries++ };
        shell: pwsh

      - name: Apply migrations
        run: |
          Write-Host "Applying migrations...";
          Get-ChildItem migrations/*.sql | ForEach-Object { psql -h localhost -p 5432 -U postgres -d postgres -f $_.FullName }
        shell: pwsh

      - name: Seed E2E data
        run: |
          cd backend && npm run seed:e2e
        shell: pwsh

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps

      - name: Run E2E tests (with test-mode)
        working-directory: frontend
        env:
          BASE_URL: http://localhost:3000
          TEST_ENABLE_RESET_LINK_TO_RESPONSE: '1'
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
        run: npm run test:e2e


  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [root, backend]
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5

    env:
      DATABASE_URL: postgres://postgres:postgres@localhost:5432/postgres

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Install Artillery
        run: npm install -g artillery

      - name: Wait for Postgres
        run: |
          Write-Host "Waiting for Postgres to be ready...";
          $retries = 0; while ($retries -lt 10) { if (pg_isready -h localhost -p 5432 -U postgres) { break } ; Start-Sleep -Seconds 2; $retries++ };
        shell: pwsh

      - name: Apply migrations
        run: |
          Write-Host "Applying migrations...";
          Get-ChildItem migrations/*.sql | ForEach-Object { psql -h localhost -p 5432 -U postgres -d postgres -f $_.FullName }
        shell: pwsh

      - name: Seed performance test data
        run: |
          cd backend && npm run seed:e2e
        shell: pwsh

      - name: Run performance tests
        run: node performance-tests/run-performance-tests.js
        env:
          TEST_BASE_URL: http://localhost:8787

      - name: Run k6 auth performance (optional)
        run: |
          docker run --rm -v ${{ github.workspace }}/performance-tests:/scripts -w /scripts loadimpact/k6 run auth.k6.js --env BASE_URL=http://localhost:8787 --vus 10 --duration 30s
        if: always()

      - name: Upload performance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-results
          path: |
            performance-results-*.json
            performance-summary-*.json
          retention-days: 30

